---
title: "AutoFocus"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(magrittr)
library(plotly)
library(dendextend)
library(igraph)
library(DT)

source(codes.makepath("autofocus/Frontend_Modules.R"))
load("~/Box/results/Annalise/QD_R.rda")
R <- QD_results_lm
  
dend<-plot_dend(R) 

selected_node = reactiveValues(n = NA,last=NA)
observeEvent(event_data("plotly_click"),{
  d<-event_data("plotly_click")
  if (!is.null(d$y)){
    if (d$y > 0){
      selected_node$last = selected_node$n
      selected_node$n = which(R$clust_info$Coord_Y ==round(d$y,digits=10))
      
  }}})

    y_axis <- list(
      title = "",
      showline = TRUE,
      showticklabels = F,
      mirror="ticks",
      showgrid = F,
      zeroline = F,
      linecolor = toRGB("black"),
      linewidth = 2
    )
    x_axis <- list(
      title = "",
      showline = TRUE,
      showticklabels = F,
      mirror="ticks",
      showgrid = F,
      zeroline = F,
      linecolor = toRGB("black"),
      linewidth = 2
    )
```


Row 
-----------------------------------------------------------------------


### Dendrogram View 

```{r}
renderPlotly({
 
    ### Dendrogram ###
    view_range <- match(R$clusts[as.double(selected_node$n)][[1]], R$HCL$order)
    x_range <- c((min(view_range)-1),(max(view_range)+1))
    y <- R$clust_info[selected_node$n,]$Coord_Y
    y_range <- c(-(y*0.1), y+(y*0.1))

    x_axis$range <- x_range
    y_axis$range <- y_range
    if (!is.na(selected_node$last)){
      dend<-
        add_markers(dend,
                          x=R$clust_info[selected_node$n,]$Coord_X,
                          y=R$clust_info[selected_node$n,]$Coord_Y,
                          marker = list(color = R$colors[selected_node$last], size = 9))
      }
    dend<-add_markers(dend,
                  x=R$clust_info[selected_node$n,]$Coord_X,
                  y=R$clust_info[selected_node$n,]$Coord_Y,
                  marker = list(color = "yellow", size = 9)) %>% 

    layout(
      xaxis = x_axis,
      yaxis = y_axis,
      showlegend = F
    )
  })
```

Row 
-----------------------------------------------------------------------

### Module List View

```{r}
DT::renderDataTable(
    datatable(R$clust_info, fillContainer = TRUE))
```

Row 
-----------------------------------------------------------------------

### Node Annotations

```{r}
renderPlotly({
    axis <- list(
      
      showline = TRUE,
      showticklabels = F,
      mirror="ticks",
      showgrid = F,
      zeroline = F,
      linecolor = toRGB("black"),
      linewidth = 2
    )
    if (is.na(selected_node$n)){
      sunburst = plotly_empty() %>% 
        add_annotations(text = "Select a Cluster for Annotation Details", showarrow = F) %>% 
        layout(xaxis = axis, yaxis = axis)

    }

    else{
      barplot_df <- get_anno_data(R, selected_node$n)
      sunburst <- plot_ly(barplot_df, labels = ~labels, parents = ~parents, values = ~values,type = 'sunburst', branchvalues = 'remainder')
    }
    
    sunburst %>% layout(
      title="Module Node Annotations")
    sunburst
    }
  )
```


Row 
-----------------------------------------------------------------------
### Node List

```{r}
DT::renderDataTable(
    datatable(data.frame(R$annos[R$clusts[[selected_node$n]],])), options = list(scrollX = '400px', scrollY='360px'), fillContainer = TRUE)
```

